<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="assets/style.css">
    <link href="https://fonts.googleapis.com/css?family=Eater|Fredericka+the+Great&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="assets/javascript/timer.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="assets/javascript/popup.js"></script>
    <script src="assets/javascript/paintings.js" type="text/javascript"></script>
    <title>Game</title>

</head>

<body>
    <header>
        <div class="header"></div>
        <h1 id="game">ArtTrackr</h1>
    </header>

    <div class="container-fluid mt-5">
        <div id="rules">
            <div class="container">
                <div class="row">
                    <div class="col-md-12 text-center" style="color: white">
                        <p><strong>Welcome to our game, here is how to play: </strong></p>
                    </div>
                </div>
                <div class="row" style="color: white">
                    <div class="col-md-12">
                        <h2 class="text-center">Rules</h2>
                    </div>
                </div>
                <div class="row" style="color: white">
                    <div class="col-md-12">
                        <ul>
                            <li>Hover over a Met card to see a painting</li>
                            <li>Make a guess about where the painting was found / from</li>
                            <li>On the map, select a location of your guess / where you think the painting came from
                            </li>
                            <li>Click on the marker to see the exact coordinates pop up under the confirm button</li>
                            <li>When you feel confident about your answer, please press the confirm button.</li>
                            <li>When you are ready to play, press the start button.</li>
                        </ul>
                    </div>
                </div>

                <div class="row">
                    <div class=" col-md-12 text-center">
                        <button id="start" class="gamebutton btn-danger">Start Game</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-3">
                    <div class="left text-center" style="display:none">
                        <h2 id="blinking">Guess</h2>
                        <div class="flip-container" ontouchstart="this.classList.toggle('hover');">
                            <div class="flipper">
                                <div class="front text-center">
                                    <!-- front content -->
                                    <img id="card-front" src="assets/photos/themnet.png" alt="themet" style="width:280px;height:280px;margin-left: 45px">
                                </div>
                                <div class="back">
                                    <!-- back content -->
                                    <img id="card-back" src="" alt="themet" style="width:280px;height:280px;margin-left: 45px">

                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="row">
                            <div class="col-md-12">

                                <button type="button" class="btn btn-danger mb-4" data-toggle="modal" data-target="#exampleModal" style="width: 100%; padding: 30px; font-size: 30px">
                                                    Enlarge Image
                                                  </button>

                                <!-- Modal -->
                                <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-xl" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="exampleModalLabel">Enlarged Image</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                          </button>
                                            </div>
                                            <div class="modal-body modal-xl">
                                                <img id="modalImage" src="" alt="themet" style="width:100%;height:680px;">
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="btn-danger" style="width: 100%; padding: 30px; font-size: 30px">More Information</button>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="middle" style="display:none">
                        <h1 id="blinking">Hints</h1>
                        <div class="row mt-3">
                            <div class="col-12">

                                <div id="box1" style="border: 2px solid red; background-color: white; display: none;padding: 45px; font-size: 20px">Year</div>
                            </div>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col-12">
                                <div id="box2" style="border: 2px solid red; background-color: white; display: none;padding: 45px; font-size: 20px">Picture </div>
                            </div>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col-12">
                                <div id="box3" style="border: 2px solid red; background-color: white; display: none;padding: 45px; font-size: 20px">Artist</div>
                            </div>
                        </div>
                        <button class="btn-danger" id="toggleButton" type="hintbutton" value="Show me the hints" onclick="counter++; toggle4('box');">Show me the hints</button>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="right" style="display:none">
                        <div id="map" style="width:100%;height:400px;"></div>
                        <div id="confirm"></div>
                        <div class="row">
                            <div class="col-md-12">
                                <button class="gamebutton btn-success" id="confirmbtn">Confirm</button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 ">
                                <button class="gamebutton btn-danger" id="remove">Remove Marker</button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div id="timer" class="text-center mt-2" style="background-color: black">
                                    <input id="minutes" type="text" style="width: 80px; border: none; background-color:none; font-size: 50px; font-weight: bold;"><strong style="width: 80px; border: none; background-color:none; font-size: 50px; font-weight: bold;color: white">:</strong>
                                    <input id="seconds" type="text" style="width: 80px; border: none; background-color:none; font-size: 50px; font-weight: bold;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-app.js"></script>

    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-database.js"></script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDHeAalyyUVCl_jItqwWPfSvl-8z43zKgY&callback=initMap&libraries=geometry">
    </script>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyB420dbXqOitzsFpOadhefGUk4Iz-B9pw4",
            authDomain: "maps-9e782.firebaseapp.com",
            databaseURL: "https://maps-9e782.firebaseio.com",
            projectId: "maps-9e782",
            storageBucket: "maps-9e782.appspot.com",
            messagingSenderId: "543986042979",
            appId: "1:543986042979:web:6f2b6e692246fea2"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        var database = firebase.database();

        $("#start").on("click", function() {
            countdown();
            $("#rules").css("display", "none");
            $(".left").css("display", "");
            $(".right").css("display", "");
            $(".middle").css("display", "");
        })
        var randomPainting = paintingsArray[Math.floor(Math.random() * paintingsArray.length)];
        $("#card-back").attr("src", randomPainting.source);

        $("#modalImage").attr("src", randomPainting.source);

        var counter = 0;
        var numHints = 3;

        function toggle4(showHideDiv) {
            var ele = document.getElementById(showHideDiv + counter);
            if (ele.style.display == "block") {
                ele.style.display = "none";
            } else {
                ele.style.display = "block";
            }
            if (counter == numHints) {
                document.getElementById("toggleButton").style.display = "none";
            }
        }

        $("#toggleButton").on("click", function() {
            $("#box1").html(`Year: ${randomPainting.year}`);
            $("#box2").html(`Title: ${randomPainting.name}`)
            $("#box3").html(`Artist: ${randomPainting.artist}`)
        });



        database.ref().set({
            lat: randomPainting.lat,
            lng: randomPainting.log
        })

        var data = {
            sender: null,
            timestamp: null,
            lat: null,
            lng: null
        };

        function makeInfoBox(controlDiv, map) {
            // Set CSS for the control border.
            var controlUI = document.createElement('div');
            controlUI.style.boxShadow = 'rgba(0, 0, 0, 0.298039) 0px 1px 4px -1px';
            controlUI.style.backgroundColor = '#fff';
            controlUI.style.border = '2px solid #fff';
            controlUI.style.borderRadius = '2px';
            controlUI.style.marginBottom = '22px';
            controlUI.style.marginTop = '10px';
            controlUI.style.marginLeft = '130px';
            controlUI.style.textAlign = 'center';
            controlDiv.appendChild(controlUI);

            // Set CSS for the control interior.
            var controlText = document.createElement('div');
            controlText.style.color = 'rgb(25,25,25)';
            controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
            controlText.style.fontSize = '100%';
            controlText.style.padding = '6px';
            controlText.textContent =
                'To change your marker, you must remove it then add a new one.';
            controlUI.appendChild(controlText);
        }

        /**
         * Starting point for running the program. Authenticates the user.
         * @param {function()} onAuthSuccess - Called when authentication succeeds.
         */
        function initAuthentication(onAuthSuccess) {
            firebase.auth().signInAnonymously().catch(function(error) {
                console.log(error.code + ', ' + error.message);
            }, {
                remember: 'sessionOnly'
            });

            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    data.sender = user.uid;
                    onAuthSuccess();
                } else {
                    // User is signed out.
                }
            });
        }

        /**
         * Creates a map object with a click listener and a heatmap.
         */
        function initMap() {
            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer;
            var map = new google.maps.Map(document.getElementById('map'), {
                center: {
                    lat: 0,
                    lng: 0
                },
                zoom: 1,
                styles: [{
                    elementType: 'geometry',
                    stylers: [{
                        color: '#242f3e'
                    }]
                }, {
                    elementType: 'labels.text.stroke',
                    stylers: [{
                        color: '#242f3e'
                    }]
                }, {
                    elementType: 'labels.text.fill',
                    stylers: [{
                        color: '#746855'
                    }]
                }, {
                    featureType: 'administrative.locality',
                    elementType: 'labels.text.fill',
                    stylers: [{
                        color: '#d59563'
                    }]
                }, {
                    featureType: 'poi',
                    elementType: 'labels.text.fill',
                    stylers: [{
                        color: '#d59563'
                    }]
                }, {
                    featureType: 'poi.park',
                    elementType: 'geometry',
                    stylers: [{
                        color: '#263c3f'
                    }]
                }, {
                    featureType: 'poi.park',
                    elementType: 'labels.text.fill',
                    stylers: [{
                        color: '#6b9a76'
                    }]
                }, {
                    featureType: 'road',
                    elementType: 'geometry',
                    stylers: [{
                        color: '#38414e'
                    }]
                }, {
                    featureType: 'road',
                    elementType: 'geometry.stroke',
                    stylers: [{
                        color: '#212a37'
                    }]
                }, {
                    featureType: 'road',
                    elementType: 'labels.text.fill',
                    stylers: [{
                        color: '#9ca5b3'
                    }]
                }, {
                    featureType: 'road.highway',
                    elementType: 'geometry',
                    stylers: [{
                        color: '#746855'
                    }]
                }, {
                    featureType: 'road.highway',
                    elementType: 'geometry.stroke',
                    stylers: [{
                        color: '#1f2835'
                    }]
                }, {
                    featureType: 'road.highway',
                    elementType: 'labels.text.fill',
                    stylers: [{
                        color: '#f3d19c'
                    }]
                }, {
                    featureType: 'transit',
                    elementType: 'geometry',
                    stylers: [{
                        color: '#2f3948'
                    }]
                }, {
                    featureType: 'transit.station',
                    elementType: 'labels.text.fill',
                    stylers: [{
                        color: '#d59563'
                    }]
                }, {
                    featureType: 'water',
                    elementType: 'geometry',
                    stylers: [{
                        color: '#17263c'
                    }]
                }, {
                    featureType: 'water',
                    elementType: 'labels.text.fill',
                    stylers: [{
                        color: '#515c6d'
                    }]
                }, {
                    featureType: 'water',
                    elementType: 'labels.text.stroke',
                    stylers: [{
                        color: '#17263c'
                    }]
                }],
                disableDoubleClickZoom: true,
                streetViewControl: false,
            });
            directionsDisplay.setMap(map);

            function clearMarkers() {
                setMapOnAll(null);
            }

            function placeMarker(map, location) {
                marker = new google.maps.Marker({
                    position: location,
                    map: map,
                    draggable: false,
                    animation: google.maps.Animation.DROP,
                });
            }


            function calcDistance(fromLat, fromLng, toLat, toLng) {
                return google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(fromLat, fromLng), new google.maps.LatLng(toLat, toLng)) / 1000;
            }


            google.maps.event.addListener(map, 'click', function(event) {
                var userLat = event.latLng.lat();
                var userLng = event.latLng.lng();
                placeMarker(map, event.latLng);

                map.setCenter(event.latLng);
                $("#confirm").html("Your location is currently " + event.latLng +
                    ". Please press the confirm button if this is your final guess.");

                $("#remove").on("click", function() {
                    marker.setMap(null);
                    $("#confirm").html('')
                })
                marker.addListener('click', toggleBounce);

                // start
                function calculateAndDisplayRoute(val, val2, directionsService, directionsDisplay) {
                    var waypts = [];

                    var start = `${randomPainting.lat}, ${randomPainting.log}`;

                    var request = {
                        origin: marker.getPosition(),
                        destination: {
                            lat: val,
                            lng: val2
                        },
                        // optimizeWaypoints: true,
                        travelMode: 'WALKING'
                    }
                    directionsService.route(request, function(response, status) {
                        if (status === 'OK') {
                            directionsDisplay.setDirections(response);
                            var route = response.routes[0];
                            // For each route, display summary information.
                        } else {
                            console.log('Directions request failed due to ' + status);
                        }
                    });
                }

                database.ref().on('value', function(snapshot) {
                    // console.log(snapshot.val())

                    var sv = snapshot.val();
                    var svLat = snapshot.val().lat;
                    var svLong = snapshot.val().lng;

                    $("#confirmbtn").on("click", function() {
                        placeMarker(map, sv)
                        $("#confirm").html(
                                `Great guess! The actual distance between your point and where the painting was founded is ${calcDistance(userLat, userLng, svLat, svLong).toFixed(2)} km`
                            )
                            // calculating score based on distance
                        var distance = calcDistance(userLat, userLng, svLat, svLong);
                        var score = 0;
                        if (distance >= 2000) {
                            console.log("Score is ", score);
                            $("#confirm").append("<p>You got " + score + " points!");
                        } else {
                            score = Math.floor(((2000 - distance) / 2000) * 100);
                            console.log("Score is ", score);
                            $("#confirm").append("<p>You got " + score + " points!");
                        }
                        calculateAndDisplayRoute(userLat, userLng, directionsService,
                            directionsDisplay);
                        stop();
                    })
                })

            });

            function toggleBounce() {
                if (marker.getAnimation() !== null) {
                    marker.setAnimation(null);
                } else {
                    marker.setAnimation(google.maps.Animation.BOUNCE);
                }
            }

            function drop() {
                for (var i = 0; i < markerArray.length; i++) {
                    setTimeout(function() {
                        addMarkerMethod();
                    }, i * 200);
                }
            }

            // Create the DIV to hold the control and call the makeInfoBox() constructor
            // passing in this DIV.
            var infoBoxDiv = document.createElement('div');
            makeInfoBox(infoBoxDiv, map);
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(infoBoxDiv);

            // Listen for clicks and add the location of the click to firebase.
            map.addListener('click', function(e) {
                data.lat = e.latLng.lat();
                data.lng = e.latLng.lng();
                addToFirebase(data);
            });


        }


        function initFirebase(heatmap) {

            // 10 minutes before current time.
            var startTime = new Date().getTime() - (60 * 10 * 1000);

            // Reference to the clicks in Firebase.
            var clicks = firebase.database().ref('clicks');

            // Listen for clicks and add them to the heatmap.
            clicks.orderByChild('timestamp').startAt(startTime).on('child_added',
                function(snapshot) {
                    // Get that click from firebase.
                    var newPosition = snapshot.val();
                    var point = new google.maps.LatLng(newPosition.lat, newPosition.lng);
                    var elapsedMs = Date.now() - newPosition.timestamp;

                    // Add the point to the heatmap.
                    // heatmap.getData().push(point);

                    // Request entries older than expiry time (10 minutes).
                    var expiryMs = Math.max(60 * 10 * 1000 - elapsedMs, 0);

                    // Set client timeout to remove the point after a certain time.
                    window.setTimeout(function() {
                        // Delete the old point from the database.
                        snapshot.ref.remove();
                    }, expiryMs);
                }
            );

            // Remove old data from the heatmap when a point is removed from firebase.
            // clicks.on('child_removed', function(snapshot, prevChildKey) {
            //     var heatmapData = heatmap.getData();
            //     var i = 0;
            //     while (snapshot.val().lat != heatmapData.getAt(i).lat() ||
            //         snapshot.val().lng != heatmapData.getAt(i).lng()) {
            //         i++;
            //     }
            //     heatmapData.removeAt(i);
            // });
        }

        /**
         * Updates the last_message/ path with the current timestamp.
         * @param {function(Date)} addClick After the last message timestamp has been updated,
         *     this function is called with the current timestamp to add the
         *     click to the firebase.
         */
        function getTimestamp(addClick) {
            // Reference to location for saving the last click time.
            var ref = firebase.database().ref('last_message/' + data.sender);

            ref.onDisconnect().remove(); // Delete reference from firebase on disconnect.

            // Set value to timestamp.
            ref.set(firebase.database.ServerValue.TIMESTAMP, function(err) {
                if (err) { // Write to last message was unsuccessful.
                    console.log(err);
                } else { // Write to last message was successful.
                    ref.once('value', function(snap) {
                        addClick(snap.val()); // Add click with same timestamp.
                    }, function(err) {
                        console.warn(err);
                    });
                }
            });
        }

        /**
         * Adds a click to firebase.
         * @param {Object} data The data to be added to firebase.
         *     It contains the lat, lng, sender and timestamp.
         */
        function addToFirebase(data) {
            getTimestamp(function(timestamp) {
                // Add the new timestamp to the record data.
                data.timestamp = timestamp;
                var ref = firebase.database().ref('clicks').push(data, function(err) {
                    if (err) { // Data was not written to firebase.
                        console.warn(err);
                    }
                });
            });
        }
    </script>

</body>

</html>