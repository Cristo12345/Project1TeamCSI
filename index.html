<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="assets/style.css">
    <link href="https://fonts.googleapis.com/css?family=Eater|Fredericka+the+Great&display=swap" rel="stylesheet">
    <script src="assets/javascript/timer.js"></script>

    <title>Game</title>

</head>

<body>
    <header>
        <div class="header"></div>
        <h1 id="game">Game</h1>
        <nav>
            <ul class="nav inline-items">
                <li><strong><a href="#">Home</a></strong></li>
                <li><strong><a href="#">Blog</a></strong></li>
                <li><strong><a href="#">Game</a></strong></li>
            </ul>
        </nav>
    </header>

    <div class="columns-container">
        <div id="rules">
            <div class="container">
                <div class="row">
                    <div class="col-md-12 text-center">
                        <p><strong>Welcome to our game, here is how to play: </strong></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <h2 class="text-center">Rules</h2>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <ul>
                            <li>Hover over a Met card to see a painting</li>
                            <li>Make a guess about where the painting was found / from</li>
                            <li>On the map, select a location of your guess / where you think the painting came from</li>
                            <li>Click on the marker to see the exact coordinates pop up under the confirm button</li>
                            <li>When you feel confident about your answer, please press the confirm button.</li>
                            <li>When you are ready to play, press the start button.</li>
                        </ul>
                    </div>
                </div>

                <div class="row">
                    <div class=" col-md-12 text-center">
                        <button id="start" class="gamebutton btn-danger">Start Game</button>

                    </div>
                </div>
            </div>

        </div>

        <div class="left-column" style="display:none">
            <h2 id="blinking">Guess</h2>
            <input id="minutes" type="text" style="width: 80px; border: none; background-color:none; font-size: 50px; font-weight: bold;"><strong style="width: 80px; border: none; background-color:none; font-size: 50px; font-weight: bold;">:</strong>
            <input id="seconds" type="text" style="width: 80px; border: none; background-color:none; font-size: 50px; font-weight: bold;">

            <div class="flip-container" ontouchstart="this.classList.toggle('hover');">
                <div class="flipper">
                    <div class="front">
                        <!-- front content -->

                        <img src="assets/photos/themnet.png" alt="themet" style="width:280px;height:280px;">
                    </div>
                    <div class="back">
                        <!-- back content -->
                        <img src="https://images-na.ssl-images-amazon.com/images/I/41IEHKYmcuL._SX425_.jpg" alt="themet" style="width:280px;height:280px;">
                    </div>
                </div>
            </div>
            <!--<div class="paragraph">
                <p><strong>Lorem ipsum dolor sit amet consectetur adipisicing elit. Animi ut minus commodi autem quia laudantium ratione rerum labore iure porro optio incidunt nam nulla dolore, culpa quas eveniet aliquid doloribus?</strong></p>
            </div> -->
        </div>
    </div>

    <div class="right-column" style="display:none">
        <div id="map" style="width:100%;height:400px;"></div>
        <div id="confirm"></div>
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <button class="gamebutton btn-success" id="confirmbtn">Confirm</button>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 ">
                    <button class="gamebutton btn-danger" id="remove">Remove Marker</button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p><a href="#">Contact Us</a> | <a href="#">Sitemap</a> | <a href="#">Privacy Policy</a></p>
        <p>&copy;2019 Copyright </p>
    </footer>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <script>
        $("#start").on("click", function() {
            $("#rules").css("display", "none");
            $(".left-column").css("display", "");
            $(".right-column").css("display", "");
            countdown();
        })
    </script>
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-app.js"></script>

    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-database.js"></script>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyB420dbXqOitzsFpOadhefGUk4Iz-B9pw4",
            authDomain: "maps-9e782.firebaseapp.com",
            databaseURL: "https://maps-9e782.firebaseio.com",
            projectId: "maps-9e782",
            storageBucket: "maps-9e782.appspot.com",
            messagingSenderId: "543986042979",
            appId: "1:543986042979:web:6f2b6e692246fea2"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        var database = firebase.database();

        var data = {
            sender: null,
            timestamp: null,
            lat: null,
            lng: null
        };

        function makeInfoBox(controlDiv, map) {
            // Set CSS for the control border.
            var controlUI = document.createElement('div');
            controlUI.style.boxShadow = 'rgba(0, 0, 0, 0.298039) 0px 1px 4px -1px';
            controlUI.style.backgroundColor = '#fff';
            controlUI.style.border = '2px solid #fff';
            controlUI.style.borderRadius = '2px';
            controlUI.style.marginBottom = '22px';
            controlUI.style.marginTop = '10px';
            controlUI.style.textAlign = 'center';
            controlDiv.appendChild(controlUI);

            // Set CSS for the control interior.
            var controlText = document.createElement('div');
            controlText.style.color = 'rgb(25,25,25)';
            controlText.style.fontFamily = 'Roboto,Arial,sans-serif';
            controlText.style.fontSize = '100%';
            controlText.style.padding = '6px';
            controlText.textContent =
                'The map shows all clicks made in the last 10 minutes.';
            controlUI.appendChild(controlText);
        }

        /**
         * Starting point for running the program. Authenticates the user.
         * @param {function()} onAuthSuccess - Called when authentication succeeds.
         */
        function initAuthentication(onAuthSuccess) {
            firebase.auth().signInAnonymously().catch(function(error) {
                console.log(error.code + ', ' + error.message);
            }, {
                remember: 'sessionOnly'
            });

            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    data.sender = user.uid;
                    onAuthSuccess();
                } else {
                    // User is signed out.
                }
            });
        }

        /**
         * Creates a map object with a click listener and a heatmap.
         */
        function initMap() {
            var map = new google.maps.Map(document.getElementById('map'), {
                center: {
                    lat: 0,
                    lng: 0
                },
                zoom: 3,
                styles: [{
                    elementType: 'geometry',
                    stylers: [{
                        color: '#242f3e'
                    }]
                }, {
                    elementType: 'labels.text.stroke',
                    stylers: [{
                        color: '#242f3e'
                    }]
                }, {
                    elementType: 'labels.text.fill',
                    stylers: [{
                        color: '#746855'
                    }]
                }, {
                    featureType: 'administrative.locality',
                    elementType: 'labels.text.fill',
                    stylers: [{
                        color: '#d59563'
                    }]
                }, {
                    featureType: 'poi',
                    elementType: 'labels.text.fill',
                    stylers: [{
                        color: '#d59563'
                    }]
                }, {
                    featureType: 'poi.park',
                    elementType: 'geometry',
                    stylers: [{
                        color: '#263c3f'
                    }]
                }, {
                    featureType: 'poi.park',
                    elementType: 'labels.text.fill',
                    stylers: [{
                        color: '#6b9a76'
                    }]
                }, {
                    featureType: 'road',
                    elementType: 'geometry',
                    stylers: [{
                        color: '#38414e'
                    }]
                }, {
                    featureType: 'road',
                    elementType: 'geometry.stroke',
                    stylers: [{
                        color: '#212a37'
                    }]
                }, {
                    featureType: 'road',
                    elementType: 'labels.text.fill',
                    stylers: [{
                        color: '#9ca5b3'
                    }]
                }, {
                    featureType: 'road.highway',
                    elementType: 'geometry',
                    stylers: [{
                        color: '#746855'
                    }]
                }, {
                    featureType: 'road.highway',
                    elementType: 'geometry.stroke',
                    stylers: [{
                        color: '#1f2835'
                    }]
                }, {
                    featureType: 'road.highway',
                    elementType: 'labels.text.fill',
                    stylers: [{
                        color: '#f3d19c'
                    }]
                }, {
                    featureType: 'transit',
                    elementType: 'geometry',
                    stylers: [{
                        color: '#2f3948'
                    }]
                }, {
                    featureType: 'transit.station',
                    elementType: 'labels.text.fill',
                    stylers: [{
                        color: '#d59563'
                    }]
                }, {
                    featureType: 'water',
                    elementType: 'geometry',
                    stylers: [{
                        color: '#17263c'
                    }]
                }, {
                    featureType: 'water',
                    elementType: 'labels.text.fill',
                    stylers: [{
                        color: '#515c6d'
                    }]
                }, {
                    featureType: 'water',
                    elementType: 'labels.text.stroke',
                    stylers: [{
                        color: '#17263c'
                    }]
                }],
                disableDoubleClickZoom: true,
                streetViewControl: false,
            });

            function clearMarkers() {
                setMapOnAll(null);
            }

            function placeMarker(map, location) {
                marker = new google.maps.Marker({
                    position: location,
                    map: map,
                    draggable: false,
                    animation: google.maps.Animation.DROP,
                });
            }

            google.maps.event.addListener(map, 'click', function(event) {
                placeMarker(map, event.latLng);
                console.log(event.latLng);

                map.setCenter(event.latLng);
                $("#confirm").html("Your location is currently " + event.latLng + ". Please press the confirm button if this is your final guess.");


                $("#confirmbtn").on("click", function() {
                    database.ref().push({
                        position: marker.position

                    })

                })

                $("#remove").on("click", function() {
                    marker.setMap(null);
                    $("#confirm").html('')
                })
                marker.addListener('click', toggleBounce);
            });

            function toggleBounce() {
                if (marker.getAnimation() !== null) {
                    marker.setAnimation(null);
                } else {
                    marker.setAnimation(google.maps.Animation.BOUNCE);
                }

            }


            function drop() {
                for (var i = 0; i < markerArray.length; i++) {
                    setTimeout(function() {
                        addMarkerMethod();
                    }, i * 200);
                }
            }

            // Create the DIV to hold the control and call the makeInfoBox() constructor
            // passing in this DIV.
            var infoBoxDiv = document.createElement('div');
            makeInfoBox(infoBoxDiv, map);
            map.controls[google.maps.ControlPosition.TOP_CENTER].push(infoBoxDiv);

            // Listen for clicks and add the location of the click to firebase.
            map.addListener('click', function(e) {
                data.lat = e.latLng.lat();
                data.lng = e.latLng.lng();
                addToFirebase(data);
            });

            // Create a heatmap.
            var heatmap = new google.maps.visualization.HeatmapLayer({
                data: [],
                map: map,
                radius: 16
            });

            initAuthentication(initFirebase.bind(undefined, heatmap));
        }

        /**
         * Set up a Firebase with deletion on clicks older than expiryMs
         * @param {!google.maps.visualization.HeatmapLayer} heatmap The heatmap to
         */
        function initFirebase(heatmap) {

            // 10 minutes before current time.
            var startTime = new Date().getTime() - (60 * 10 * 1000);

            // Reference to the clicks in Firebase.
            var clicks = firebase.database().ref('clicks');

            // Listen for clicks and add them to the heatmap.
            clicks.orderByChild('timestamp').startAt(startTime).on('child_added',
                function(snapshot) {
                    // Get that click from firebase.
                    var newPosition = snapshot.val();
                    var point = new google.maps.LatLng(newPosition.lat, newPosition.lng);
                    var elapsedMs = Date.now() - newPosition.timestamp;

                    // Add the point to the heatmap.
                    heatmap.getData().push(point);

                    // Request entries older than expiry time (10 minutes).
                    var expiryMs = Math.max(60 * 10 * 1000 - elapsedMs, 0);

                    // Set client timeout to remove the point after a certain time.
                    window.setTimeout(function() {
                        // Delete the old point from the database.
                        snapshot.ref.remove();
                    }, expiryMs);
                }
            );

            // Remove old data from the heatmap when a point is removed from firebase.
            clicks.on('child_removed', function(snapshot, prevChildKey) {
                var heatmapData = heatmap.getData();
                var i = 0;
                while (snapshot.val().lat != heatmapData.getAt(i).lat() ||
                    snapshot.val().lng != heatmapData.getAt(i).lng()) {
                    i++;
                }
                heatmapData.removeAt(i);
            });
        }

        /**
         * Updates the last_message/ path with the current timestamp.
         * @param {function(Date)} addClick After the last message timestamp has been updated,
         *     this function is called with the current timestamp to add the
         *     click to the firebase.
         */
        function getTimestamp(addClick) {
            // Reference to location for saving the last click time.
            var ref = firebase.database().ref('last_message/' + data.sender);

            ref.onDisconnect().remove(); // Delete reference from firebase on disconnect.

            // Set value to timestamp.
            ref.set(firebase.database.ServerValue.TIMESTAMP, function(err) {
                if (err) { // Write to last message was unsuccessful.
                    console.log(err);
                } else { // Write to last message was successful.
                    ref.once('value', function(snap) {
                        addClick(snap.val()); // Add click with same timestamp.
                    }, function(err) {
                        console.warn(err);
                    });
                }
            });
        }

        /**
         * Adds a click to firebase.
         * @param {Object} data The data to be added to firebase.
         *     It contains the lat, lng, sender and timestamp.
         */
        function addToFirebase(data) {
            getTimestamp(function(timestamp) {
                // Add the new timestamp to the record data.
                data.timestamp = timestamp;
                var ref = firebase.database().ref('clicks').push(data, function(err) {
                    if (err) { // Data was not written to firebase.
                        console.warn(err);
                    }
                });
            });
        }
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDHeAalyyUVCl_jItqwWPfSvl-8z43zKgY&callback=initMap">
    </script>
</body>

</html>